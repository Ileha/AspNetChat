@page
@* @using Newtonsoft.Json *@
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model AspNetChat.Pages.ChatRoomModel
@{
}

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="ChatRoom.css">
	<title>Chat Interface</title>
	<script>
		window.onbeforeunload = function()
		{
			let disconnectURL = new URL(`${window.location.origin}/UserDisconnected/@(Model.Chat!.Id)`);

			disconnectURL.searchParams.append("userID", "@(Model.ChatUser!.Id)");

			fetch(disconnectURL.href,
			{
			  method: "POST",
			  headers: {'Content-Type': 'application/json'}
			})
		}

		function sendMessage()
		{
			let message = document.getElementById("chat-input").value;

			let sendURL = new URL(`${window.location.origin}/UserSendMessage/@(Model.Chat!.Id)`);

			sendURL.searchParams.append("userID", "@(Model.ChatUser!.Id)");
			sendURL.searchParams.append("message", message);

			fetch(sendURL.href,
			{
			  method: "POST",
			  headers: {'Content-Type': 'application/json'}
			})

			document.getElementById("chat-input").value = "";
		}

		function composeMessages(data)
		{
			let chatContainer = document.getElementById("chat-history");

			

			const para = document.createElement("p");
			para.appendChild(document.createTextNode("This is new."));
		}

		const wsUrl = new URL(`${window.location.origin}/ChatHandler/@(Model.Chat!.Id)`);
		wsUrl.searchParams.append("userID", "@(Model.ChatUser!.Id)");
		wsUrl.protocol = "wss";

		console.log(wsUrl.href);

		const socket = new WebSocket(wsUrl.href);

		socket.onmessage = function (event) {
			console.log(`[message] Данные получены с сервера: ${event.data}`);
			return false;
		};

		socket.onclose = function (event) {
			if (event.wasClean) {
				console.log(`[close] Connection closed, code=${event.code} reason=${event.reason}`);
			}
			else {
				console.log('[close] Connection interrupted');
			}
		};

		socket.onerror = function (error) {
			console.log(`${error}`);
		};

	</script>
</head>

<body>
	<div class="chat-container">
		<div class="chat-history" id="chat-history">
			@* <p>@(Model.MessagesList)</p>
			<p class="user">You: Hello!</p> *@
		</div>
		<div class="chat-input-container">
			<input type="text" id="chat-input" placeholder="Type your message here...">
			<button onclick="sendMessage()">Send</button>
		</div>
	</div>
</body>